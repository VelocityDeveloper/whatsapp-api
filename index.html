<!DOCTYPE html>
<html>
<head>
	<title>Whatsapp API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- This parts is optional, just for improve the styles -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/smooth-scrollbar/5.0.1/smooth-scrollbar.css" integrity="sha512-QyDQGQiuKrcAtAIPIaO+IBZNkmb/+U5dyMY2Qe64mhjKiF74QWuDhjrqgkbacfQqqFB2+fwWnan5TQHlb0mfUg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="/css/style.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/img/whatsapp.png">
</head>
<body>

	<div id="app">
        <div class="frame-chat">
            <div class="row m-0">
                <div class="col-4 col-md-3 p-0 position-relative">
                    <img src="" alt="QR Code" id="qrcode">
                    <div class="search-form">
                        <input class="form-control" placeholder="Search Contact..">
                    </div>
                    
                    <div class="sidebar-chat sidebar-chat area-kontak">
                        <ul class="list-group chat pb-5"></ul>
                    </div>
                </div>
                <div class="col position-relative p-0">
                    
                    <div class="area-pesan chat-cols">
                        <div class="chatarea">

                        </div>
                    </div>
                    <div class="fixed-chatform bg-dark">
                        <form class="kirim-chat">
                            <textarea class="body-message form-control mb-2" placeholder=""></textarea>
                            <button class="btn btn-success ms-auto me-0">Kirim</button>
                        </form>
                    </div>
                    <ul class="list-group logs d-none">
                    </ul>
                </div>
            </div>
        </div>
		
		
	</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smooth-scrollbar/5.0.1/smooth-scrollbar.js" integrity="sha512-fNprFnoeUomE0+m0nYtgoIrlUm81yW4dtuBVhMluVYlbpYEGMfEbUJJN4muTYiltfmDyWkQ5TpmwmIhdFK7qEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js" integrity="sha512-CryKbMe7sjSCDPl18jtJI5DR5jtkUWxPXWaLCst6QjH8wxDexfRJic2WRmRXmstr2Y8SxDDWuBO6CQC6IE4KTA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js" integrity="sha512-42PE0rd+wZ2hNXftlM78BSehIGzezNeQuzihiBCvUEB3CVxHvsShF86wBWwQORNxNINlBPuq7rG4WWhNiTVHFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js" integrity="sha512-he8U4ic6kf3kustvJfiERUpojM8barHoz0WYpAUDWQVn61efpm3aVAD8RWL8OloaDDzMZ1gZiubF9OSdYBqHfQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" crossorigin="anonymous"></script>
	<script>

        let Scrollbar = window.Scrollbar;
        var options = {
            alwaysShowTracks : true
        };

        Scrollbar.init(document.querySelector('.area-kontak'));
        // Scrollbar.init(document.querySelector('.area-pesan'),options);
        const chatScrollbar = Scrollbar.init(document.querySelector('.area-pesan'), {
        damping: 0.2,
        alwaysShowTracks : true
        });
        // Scrollbar.init(document.querySelector('.fixed-chatform'))

		(function($) {
            $(document).ready(function() {
                const socket = io();
                const localNumber = localStorage.getItem('number');

                $(document).on("keyup",".search-form",function() {
                    var value = $(this).val();
                    $('.list-contact').removeClass('d-none');
                    var filter = $(this).val().toLowerCase(); // get the value of the input, which we filter on
                    if(value.length > 1){
                        $('.list-contact').each(function(i, obj) {
                            $(this).addClass('d-none');
                            if($(this).attr('class').toString().indexOf(filter) > 1) {
                                $(this).removeClass('d-none');
                            }
                        });
                        
                    }
                });

                $(".kirim-chat .body-message").attr("placeholder", "Pesan akan dikirim ke "+localNumber);

                // init kontak
                socket.emit('updateDataContact', 'request Data Kontak');
                socket.on('chatMasuk', function(msg) {
                    socket.emit('updateDataContact', 'request Data Kontak karena chat masuk');
                });
                if(localNumber){
                    socket.emit('getchatbyid', localNumber);
                }
                $(document).on("click",".list-contact",function() {
                    $('.list-contact').removeClass('active');
                    $( this ).addClass('active');
                    let id = $( this ).data('id');
                    // getchatbyid
                    socket.emit('getchatbyid', id);
                    localStorage.setItem('number', id);
                    $(".kirim-chat .body-message").val('');
                    $(".kirim-chat .body-message").attr("placeholder", "Pesan akan dikirim ke "+id);
                });


                $( ".kirim-chat" ).submit(function( event ) {                   
                    let message = $(this).find(".body-message").val();
                    let localNumber =localStorage.getItem('number'); 
                    socket.emit('sentMessage', {'nomor':localNumber,'message':message});
                    $(".kirim-chat .body-message").val('');
                    event.preventDefault();
                });

                socket.on('message', function(msg) {
                    $('.logs').prepend($('<li class="list-group-item">').text(msg));
                });

                socket.on('getPicUrl', function(msg) {
                    if(msg.url){
                        $(`[data-user='`+msg.data+`']`).attr("src", msg.url);
                    } else {
                        $(`[data-user='`+msg.data+`']`).attr("src", '/img/whatsapp.png');
                    }
                });

                socket.on('getMedia', function(msg) {
                    console.log(msg);
                    const img =['jpg','jpeg','png','gif','webp'];
                    const video = ['mp4'];
                    if(img.includes(msg.ext)){
                        $('[data-media="'+msg.key+'"]').html('<img src="/download/'+msg.name+'" alt="">');
                    } else if(video.includes(msg.ext)) {
                        $('[data-media="'+msg.key+'"]').html(`
                        <video width="320" controls>
                        <source src="/download/`+msg.name+`" type="video/mp4">
                        Your browser does not support the video tag.
                        </video>`);
                    }else {
                        $('[data-media="'+msg.key+'"]').html('<a href="/download/'+msg.name+'">'+msg.name+'</a>');
                    }
                });

                socket.on('getContact', function(data) {
                    $('.chat').html('');
                    const dataListChat = data.sort();
                    // dataListChat.sort((a, b));

                    var arrayLength = dataListChat.length;
                    for (var i = 0; i < arrayLength; i++) {
                        let dataContact = dataListChat[i]?.data;
                        socket.emit('reqPicUrl', dataContact.id);
                        //Do something
                        let contact = ``
                            contact +=`<div class="row card-contact">`;
                                contact +=`<div class="col-2 px-0">`;
                                    contact +=`<img class="rounded-circle img-fluid" data-user="`+dataContact.id+`" src="" alt="">`;
                                contact +=`</div>`;
                                contact +=`<div class="col-10">`;
                                    contact +=`<div class="ms-2 me-auto">
                                    <div class="data-nama">`+dataContact.name+`</div>`;
                                    contact +=`<div style="font-size:8px;">`+moment.unix(dataContact.timestamp).format("DD-MM-YYYY h:mm:ss")+`</div>`;
                                    contact +=`</div>`;
                                    if(dataContact.unreadCount < 0){
                                        contact +=`<span class="badge bg-success rounded-pill text-success">!</span>`;
                                    } else if (dataContact.unreadCount >= 1) {
                                        contact +=`<span class="badge bg-success rounded-pill">`+dataContact.unreadCount+`</span>`;
                                    }
                                contact +=`</div>`;
                            contact +=`</div>`;
                            
                        $('.chat').append($('<li class="text-white bg-dark list-contact list-'+dataContact.nomor+' '+dataContact.name.toLowerCase()+' list-group-item align-start" data-id="'+dataContact.nomor+'"></li>')
                        .html(contact));
                    }
                    if(localNumber){
                        $('.list-'+localNumber).addClass( "active" );
                    }
                });

                socket.on('chatmasuk', function(data) {
                    socket.emit('getchatbyid', localNumber);
                });

                socket.on('kirim chat sukses', function(data) {
                    
                    setTimeout(function(){
                        socket.emit('updateDataContact', 'request Data Kontak');
                    }, 100);

                    if(localNumber == data) {
                        socket.emit('getchatbyid', localNumber);
                        $(".body-message").val('');
                    }
                    
                });

                socket.on('getChatByNumber', function(data) {
                    html = '';
                    for (var i = 0, l = data.length; i < l; i++) {
                        const value = data[i];
                        let divClass = value.fromMe == true ? 'chat-to' : 'chat-from';
                        html += '<div class="'+divClass+'"><span>';

                        if (value.hasMedia) {
                            // console.log(value);
                            html += `<div data-media="`+value.mediaKey+`"></div>`;
                        } else {
                            html += value.body;
                        }
                        html += '<div><small style="font-size:8px;">'+ moment.unix(value.timestamp).format("DD-MM-YYYY h:mm:ss") + "</small></div>";
                        html += '</span></div>';
                    }
                    $('.chatarea').html(html);
                    setTimeout(function() {
                        let tinggiChat = $('.chatarea').height();
                        chatScrollbar.scrollTo(0, tinggiChat, 0, {
                        });
                    }, 1000);
                });

                socket.on('qr', function(src) {
                    $('#qrcode').attr('src', src);
                    $('#qrcode').show();
                });

                socket.on('ready', function(data) {
                    $('#qrcode').hide();
                });

                socket.on('authenticated', function(data) {
                    $('#qrcode').hide();
                });
                socket.on('log', function(data) {
                    console.log(data);
                });
            });
        })(jQuery);
	</script>
</body>
</html>